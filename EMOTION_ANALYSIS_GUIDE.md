# 🧠 AI情绪分析功能使用指南

## 📋 功能概述

AI情绪分析功能会自动分析用户的日记内容，提取情绪评分、情绪关键词和事件关键词，为情绪分析面板提供数据支持。

## 🔄 触发时机

### 1. **新建日记时**
- 用户在 `/diary/new` 页面创建新日记
- 保存日记后自动触发AI分析
- 分析结果实时保存到数据库

### 2. **编辑日记时**
- 用户在 `/diary/[id]/edit` 页面编辑日记
- 保存修改后自动触发AI分析
- 更新数据库中的分析结果

### 3. **AI对话生成日记时**
- 用户与AI聊天后生成日记
- 日记保存后自动触发情绪分析
- 确保生成的内容也有情绪分析数据

## 🛠️ 技术实现

### **核心文件结构**
```
lib/
├── emotion-ai.ts              # 情绪分析核心函数
└── deepseek.ts               # DeepSeek AI接口

app/api/
└── ai/
    └── analyze-emotion/
        └── route.ts          # 情绪分析API接口

app/
├── diary/
│   ├── new/
│   │   └── page.tsx         # 新建日记页面
│   └── [id]/
│       └── edit/
│           └── page.tsx     # 编辑日记页面
└── api/
    └── diary/
        └── generate/
            └── route.ts     # 生成日记API
```

### **数据流程**
```
用户操作 → 保存日记 → 调用AI分析 → 更新数据库 → 情绪分析面板显示
```

## 📊 数据格式

### **AI返回的数据结构**
```json
{
  "mood_score": 10,
  "emotion_keywords": [
    "成功了",
    "值了", 
    "人生巅峰",
    "开心到语无伦次",
    "燃起来",
    "太爽了"
  ],
  "event_keywords": [
    "收到录取通知",
    "多年的努力"
  ]
}
```

### **数据库字段说明**
- `mood_score`: 情绪评分 (1-10整数)
- `emotion_keywords`: 情绪关键词数组
- `event_keywords`: 事件关键词数组
- `ai_analysis_updated_at`: 分析更新时间

## 🚀 使用方法

### **1. 确保数据库结构**
运行以下SQL脚本添加情绪分析字段：
```sql
-- 运行 scripts/022_add_emotion_analysis_fields.sql
```

### **2. 配置环境变量**
确保 `.env.local` 文件包含：
```env
DEEPSEEK_API_KEY=your_api_key_here
```

### **3. 测试功能**
1. 创建新日记 → 自动分析
2. 编辑现有日记 → 自动分析
3. 与AI对话生成日记 → 自动分析

## 🔍 故障排除

### **常见问题**

#### **1. AI分析失败**
- 检查 `DEEPSEEK_API_KEY` 是否正确配置
- 查看浏览器控制台的错误信息
- 确认网络连接正常

#### **2. 数据格式错误**
- 检查AI返回的JSON格式是否正确
- 查看API接口的日志输出
- 确认提示词格式符合要求

#### **3. 数据库更新失败**
- 检查数据库连接是否正常
- 确认用户权限和RLS策略
- 查看Supabase日志

### **调试信息**
所有关键步骤都有详细的 `console.log` 输出：
- AI分析开始
- AI分析完成
- 数据库更新结果
- 错误详情

## 📈 性能优化

### **1. 异步处理**
- 情绪分析在后台异步执行
- 不影响用户的主要操作流程
- 分析失败不影响日记保存

### **2. 错误处理**
- 完善的错误捕获和处理
- 分析失败时不影响核心功能
- 详细的错误日志记录

### **3. 数据验证**
- 验证AI返回的数据格式
- 确保数据在合理范围内
- 防止无效数据进入数据库

## 🔮 未来扩展

### **1. 批量分析**
- 支持批量分析历史日记
- 定时任务自动分析
- 手动触发分析功能

### **2. 分析历史**
- 记录每次分析的结果
- 分析准确度评估
- 用户反馈收集

### **3. 个性化优化**
- 基于用户历史数据优化提示词
- 学习用户的表达习惯
- 提供个性化的分析建议

## 📞 技术支持

如果遇到问题，请：
1. 查看浏览器控制台错误信息
2. 检查Supabase数据库日志
3. 确认环境变量配置
4. 联系开发团队获取支持

---

**注意**: 此功能需要有效的DeepSeek API密钥才能正常工作。请确保在部署前正确配置相关环境变量。
